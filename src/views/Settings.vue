<template>
  <div class="settings-container">
    <div class="settings-header">
      <div class="learning-card header-card">
        <h2>âš™ï¸ å­¦ä¹ è®¾ç½®</h2>
        <p class="description">ä¸ªæ€§åŒ–é…ç½®ä½ çš„å­¦ä¹ å‚æ•°å’Œåå¥½</p>
        <el-alert 
          title="ğŸ’¾ è®¾ç½®è‡ªåŠ¨ä¿å­˜" 
          description="æ‚¨çš„æ‰€æœ‰è®¾ç½®æ›´æ”¹ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ä¿å­˜æŒ‰é’®"
          type="info" 
          :closable="false"
          show-icon
          style="margin-top: 15px;"
        />
      </div>
    </div>
    
    <!-- å­¦ä¹ å‚æ•°è®¾ç½® -->
    <div class="learning-settings">
      <div class="learning-card">
        <h3>ğŸ“š å­¦ä¹ å‚æ•°</h3>
        <el-form :model="formSettings" label-width="140px" size="large">
          <el-form-item label="é»˜è®¤å­¦ä¹ æ•°é‡">
            <el-slider 
              v-model="formSettings.å­¦ä¹ æ•°é‡" 
              :min="5" 
              :max="50" 
              :step="5"
              :show-input="true"
              show-stops
              style="width: 300px;"
            />
            <div class="setting-tip">
              æ¨èæ–°æ‰‹é€‰æ‹©5-15ä¸ªæ±‰å­—ï¼Œæœ‰ç»éªŒè€…å¯é€‰æ‹©20-50ä¸ªæ±‰å­—
            </div>
          </el-form-item>
          

          
          <el-form-item label="é»˜è®¤æ£€æŸ¥ç±»å‹">
            <el-radio-group v-model="formSettings.æ£€æŸ¥ç±»å‹">
              <el-radio value="æ‹¼éŸ³é€‰æ±‰å­—">æ‹¼éŸ³é€‰æ±‰å­—</el-radio>
              <el-radio value="æ±‰å­—é€‰æ‹¼éŸ³">æ±‰å­—é€‰æ‹¼éŸ³</el-radio>
              <el-radio value="æ··åˆæ¨¡å¼">æ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰</el-radio>
            </el-radio-group>
            <div class="setting-tip">
              æ··åˆæ¨¡å¼å¯ä»¥å…¨é¢æ£€æŸ¥æ±‰å­—å’Œæ‹¼éŸ³çš„æŒæ¡æƒ…å†µ
            </div>
          </el-form-item>
          
          <el-form-item label="é»˜è®¤å­¦ä¹ èŒƒå›´">
            <el-radio-group v-model="formSettings.å­¦ä¹ èŒƒå›´">
              <el-radio value="å…¨æ–°æ±‰å­—">å…¨æ–°æ±‰å­—</el-radio>
              <el-radio value="è‡ªå®šä¹‰èŒƒå›´">è‡ªå®šä¹‰èŒƒå›´</el-radio>
            </el-radio-group>
            <div class="setting-tip">
              å­¦ä¹ æ–°æ±‰å­—åŒ…å«å­¦ä¹ å’Œæµ‹è¯•ä¸¤ä¸ªé˜¶æ®µ<br/>
              å¤ä¹ å·²å­¦æ±‰å­—è¯·ä½¿ç”¨"å¼€å§‹å¤ä¹ "åŠŸèƒ½
            </div>
          </el-form-item>
          
          <el-form-item label="èµ·å§‹åºå·">
            <el-input-number 
              v-model="formSettings.èµ·å§‹åºå·"
              :min="1"
              :max="2525"
              :step="1"
              size="default"
              style="width: 200px;"
            />
            <div class="setting-tip">
              è®¾ç½®ä»ç¬¬å‡ ä¸ªæ±‰å­—å¼€å§‹å­¦ä¹ ï¼Œé€‚ç”¨äºæ¢è®¾å¤‡åç»§ç»­å­¦ä¹ çš„æƒ…å†µ<br/>
              èŒƒå›´ï¼š1-2525
            </div>
          </el-form-item>
          
          <el-form-item label="ç»“æŸåºå·" v-if="formSettings.å­¦ä¹ èŒƒå›´ === 'è‡ªå®šä¹‰èŒƒå›´'">
            <el-input-number 
              v-model="formSettings.ç»“æŸåºå·"
              :min="formSettings.èµ·å§‹åºå· || 1"
              :max="2525"
              :step="1"
              size="default"
              style="width: 200px;"
              placeholder="ç•™ç©ºåˆ™å­¦ä¹ åˆ°æœ€å"
            />
            <div class="setting-tip">
              è®¾ç½®å­¦ä¹ åˆ°ç¬¬å‡ ä¸ªæ±‰å­—ï¼Œç•™ç©ºåˆ™å­¦ä¹ åˆ°æœ€åä¸€ä¸ªæ±‰å­—
            </div>
          </el-form-item>
          
          <el-form-item label="ç­”é¢˜æ—¶é—´é™åˆ¶">
            <el-select v-model="formSettings.å€’è®¡æ—¶ç§’æ•°" style="width: 200px;">
              <el-option label="æ— æ—¶é—´é™åˆ¶" :value="0" />
              <el-option label="15ç§’ï¼ˆå¿«é€Ÿï¼‰" :value="15" />
              <el-option label="30ç§’ï¼ˆæ ‡å‡†ï¼‰" :value="30" />
              <el-option label="45ç§’ï¼ˆå®½æ¾ï¼‰" :value="45" />
              <el-option label="60ç§’ï¼ˆå……è¶³ï¼‰" :value="60" />
            </el-select>
            <div class="setting-tip">
              æ—¶é—´é™åˆ¶å¯ä»¥æé«˜ååº”é€Ÿåº¦ï¼Œå»ºè®®æ ¹æ®è‡ªå·±çš„æ°´å¹³é€‰æ‹©
            </div>
          </el-form-item>
        </el-form>
      </div>
    </div>
    
    <!-- å¤ä¹ å‚æ•°è®¾ç½® -->
    <div class="review-settings">
      <div class="learning-card">
        <h3>ğŸ”„ å¤ä¹ å‚æ•°</h3>
        <el-form :model="formReviewSettings" label-width="140px" size="large">
          <el-form-item label="é»˜è®¤å¤ä¹ æ•°é‡">
            <el-slider 
              v-model="formReviewSettings.å¤ä¹ æ•°é‡" 
              :min="5" 
              :max="50" 
              :step="5"
              :show-input="true"
              show-stops
              style="width: 300px;"
            />
            <div class="setting-tip">
              å¤ä¹ ç»ƒä¹ çš„é»˜è®¤æ•°é‡è®¾ç½®
            </div>
          </el-form-item>
          
          <el-form-item label="é»˜è®¤æµ‹è¯•ç±»å‹">
            <el-radio-group v-model="formReviewSettings.æ£€æŸ¥ç±»å‹">
              <el-radio value="æ‹¼éŸ³é€‰æ±‰å­—">æ‹¼éŸ³é€‰æ±‰å­—</el-radio>
              <el-radio value="æ±‰å­—é€‰æ‹¼éŸ³">æ±‰å­—é€‰æ‹¼éŸ³</el-radio>
              <el-radio value="æ··åˆæ¨¡å¼">æ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰</el-radio>
            </el-radio-group>
            <div class="setting-tip">
              å¤ä¹ æ—¶çš„é»˜è®¤æµ‹è¯•ç±»å‹ï¼Œå¯åœ¨å¤ä¹ æ—¶å•ç‹¬è°ƒæ•´
            </div>
          </el-form-item>
          
          <el-form-item label="é»˜è®¤å¤ä¹ èŒƒå›´">
            <el-radio-group v-model="formReviewSettings.å¤ä¹ èŒƒå›´">
              <el-radio value="éœ€è¦å¤ä¹ ">éœ€è¦å¤ä¹ çš„æ±‰å­—</el-radio>
              <el-radio value="é¡ºåºå¤ä¹ ">æŒ‰å­¦ä¹ é¡ºåºå¤ä¹ </el-radio>
              <el-radio value="éšæœºå¤ä¹ ">éšæœºå¤ä¹ å·²å­¦æ±‰å­—</el-radio>
              <el-radio value="åŸºæœ¬æŒæ¡">åŸºæœ¬æŒæ¡çš„æ±‰å­—</el-radio>
              <el-radio value="å®Œå…¨æŒæ¡">å®Œå…¨æŒæ¡çš„æ±‰å­—</el-radio>
            </el-radio-group>
            <div class="setting-tip">
              é€‰æ‹©å¤ä¹ çš„é»˜è®¤èŒƒå›´ï¼Œå»ºè®®ä¼˜å…ˆå¤ä¹ "éœ€è¦å¤ä¹ "çš„æ±‰å­—
            </div>
          </el-form-item>
          
          <el-form-item label="ç­”é¢˜æ—¶é—´">
            <el-select v-model="formReviewSettings.å€’è®¡æ—¶ç§’æ•°" style="width: 200px;">
              <el-option label="æ— é™åˆ¶" :value="0" />
              <el-option label="15ç§’" :value="15" />
              <el-option label="30ç§’" :value="30" />
              <el-option label="45ç§’" :value="45" />
              <el-option label="60ç§’" :value="60" />
            </el-select>
            <div class="setting-tip">
              å¤ä¹ æ—¶çš„é»˜è®¤ç­”é¢˜æ—¶é—´
            </div>
          </el-form-item>
          
          <el-form-item label="é«˜çº§é€‰é¡¹">
            <el-checkbox v-model="formReviewSettings.æ˜¯å¦æ˜¾ç¤ºå£°è°ƒ">æ˜¾ç¤ºæ‹¼éŸ³å£°è°ƒ</el-checkbox>
            <br>
            <el-checkbox v-model="formReviewSettings.æ‰“ä¹±é€‰é¡¹é¡ºåº">æ‰“ä¹±é€‰é¡¹é¡ºåº</el-checkbox>
            <div class="setting-tip">
              å¤ä¹ æ—¶çš„é»˜è®¤é«˜çº§é€‰é¡¹è®¾ç½®
            </div>
          </el-form-item>
        </el-form>
      </div>
    </div>
    
    <!-- æ˜¾ç¤ºé€‰é¡¹è®¾ç½® -->
    <div class="display-settings">
      <div class="learning-card">
        <h3>ğŸ¨ æ˜¾ç¤ºé€‰é¡¹</h3>
        <el-form :model="formSettings" label-width="140px" size="large">
          <el-form-item label="æ‹¼éŸ³æ˜¾ç¤º">
            <el-switch 
              v-model="formSettings.æ˜¯å¦æ˜¾ç¤ºå£°è°ƒ"
              active-text="æ˜¾ç¤ºå£°è°ƒ"
              inactive-text="ä¸æ˜¾ç¤ºå£°è°ƒ"
            />
            <div class="setting-tip">
              æ˜¾ç¤ºå£°è°ƒæœ‰åŠ©äºæ­£ç¡®æŒæ¡æ±‰å­—è¯»éŸ³
            </div>
          </el-form-item>
          
          <el-form-item label="ç¬”ç”»åŠ¨ç”»">
            <el-switch 
              v-model="formSettings.æ˜¯å¦æ˜¾ç¤ºç¬”ç”»"
              active-text="æ˜¾ç¤ºç¬”ç”»"
              inactive-text="ä¸æ˜¾ç¤ºç¬”ç”»"
            />
            <div class="setting-tip">
              ç¬”ç”»åŠ¨ç”»å¯ä»¥å¸®åŠ©å­¦ä¹ æ±‰å­—ä¹¦å†™é¡ºåºï¼ˆåŠŸèƒ½å¼€å‘ä¸­ï¼‰
            </div>
          </el-form-item>
          
          <el-form-item label="ä¸»é¢˜è‰²å½©">
            <el-radio-group v-model="themeColor">
              <el-radio value="blue">è“è‰²ï¼ˆé»˜è®¤ï¼‰</el-radio>
              <el-radio value="green">ç»¿è‰²</el-radio>
              <el-radio value="purple">ç´«è‰²</el-radio>
              <el-radio value="orange">æ©™è‰²</el-radio>
            </el-radio-group>
            <div class="setting-tip">
              é€‰æ‹©ä½ å–œæ¬¢çš„ä¸»é¢˜è‰²å½©
            </div>
          </el-form-item>
          
          <el-form-item label="å­—ä½“å¤§å°">
            <el-slider 
              v-model="fontSize" 
              :min="12" 
              :max="20" 
              :step="1"
              :show-input="true"
              style="width: 200px;"
            />
            <div class="setting-tip">
              è°ƒæ•´ç•Œé¢å­—ä½“å¤§å°ï¼Œé€‚åˆä¸åŒè§†åŠ›éœ€æ±‚
            </div>
          </el-form-item>
        </el-form>
      </div>
    </div>
    
    <!-- å­¦ä¹ æé†’è®¾ç½® -->
    <div class="notification-settings">
      <div class="learning-card">
        <h3>ğŸ”” å­¦ä¹ æé†’</h3>
        <el-form label-width="140px" size="large">
          <el-form-item label="æ¯æ—¥æé†’">
            <el-switch 
              v-model="dailyReminder"
              active-text="å¼€å¯æé†’"
              inactive-text="å…³é—­æé†’"
            />
            <div class="setting-tip">
              æ¯å¤©å®šæ—¶æé†’ä½ è¿›è¡Œæ±‰å­—å­¦ä¹ 
            </div>
          </el-form-item>
          
          <el-form-item v-if="dailyReminder" label="æé†’æ—¶é—´">
            <el-time-picker
              v-model="reminderTime"
              format="HH:mm"
              placeholder="é€‰æ‹©æé†’æ—¶é—´"
            />
          </el-form-item>
          
          <el-form-item label="å­¦ä¹ ç›®æ ‡">
            <el-input-number 
              v-model="dailyGoal" 
              :min="1" 
              :max="100"
              controls-position="right"
            />
            <span style="margin-left: 8px;">ä¸ªæ±‰å­—/å¤©</span>
            <div class="setting-tip">
              è®¾ç½®æ¯æ—¥å­¦ä¹ ç›®æ ‡ï¼ŒåŸ¹å…»è‰¯å¥½çš„å­¦ä¹ ä¹ æƒ¯
            </div>
          </el-form-item>
        </el-form>
      </div>
    </div>
    
    <!-- æ•°æ®ç®¡ç† -->
    <div class="data-management">
      <div class="learning-card">
        <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
        <div class="data-actions">
          <div class="action-group">
            <h4>è®¾ç½®ç®¡ç†</h4>
            <div class="action-buttons">
              <el-button @click="exportSettings" size="large" type="success">
                <el-icon><Download /></el-icon>
                å¯¼å‡ºè®¾ç½®åˆ°æœ¬åœ°æ–‡ä»¶
              </el-button>
              <el-button @click="triggerSettingsFileInput" size="large" type="success">
                <el-icon><Upload /></el-icon>
                ä»æœ¬åœ°æ–‡ä»¶å¯¼å…¥è®¾ç½®
              </el-button>
              <!-- éšè—çš„è®¾ç½®æ–‡ä»¶è¾“å…¥ -->
              <input 
                ref="settingsFileInput"
                type="file" 
                accept=".json"
                @change="handleSettingsFileChange"
                style="display: none;"
              >
            </div>
            <div class="action-tip">
              ä¿å­˜ä¸ªäººè®¾ç½®åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œå¯åœ¨å…¶ä»–è®¾å¤‡ä¸Šå¯¼å…¥
            </div>
          </div>
          
          <div class="action-group">
            <h4>å­¦ä¹ æ•°æ®å¤‡ä»½</h4>
            <div class="action-buttons">
              <el-button @click="exportData" size="large">
                <el-icon><Download /></el-icon>
                å¯¼å‡ºå­¦ä¹ æ•°æ®
              </el-button>
              <el-button @click="triggerFileInput" size="large">
                <el-icon><Upload /></el-icon>
                å¯¼å…¥å­¦ä¹ æ•°æ®
              </el-button>
              <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
              <input 
                ref="fileInput"
                type="file" 
                accept=".json"
                @change="handleFileChange"
                style="display: none;"
              >
            </div>
            <div class="action-tip">
              å®šæœŸå¤‡ä»½å­¦ä¹ æ•°æ®ï¼Œé¿å…æ•°æ®ä¸¢å¤±
            </div>
          </div>
          
          <div class="action-group">
            <h4>åŠŸèƒ½æµ‹è¯•</h4>
            <div class="action-buttons">
              <el-button @click="generateTestData" type="primary" size="large">
                <el-icon><Tools /></el-icon>
                ç”Ÿæˆæµ‹è¯•æ•°æ®
              </el-button>
              <el-button @click="testImportExport" type="warning" size="large">
                <el-icon><Check /></el-icon>
                æµ‹è¯•å¯¼å…¥å¯¼å‡º
              </el-button>
            </div>
            <div class="action-tip">
              ç”Ÿæˆæµ‹è¯•æ•°æ®æ¥éªŒè¯å¯¼å…¥å¯¼å‡ºåŠŸèƒ½æ˜¯å¦æ­£å¸¸
            </div>
          </div>
          
          <div class="action-group">
            <h4>æ•°æ®æ¸…ç†</h4>
            <div class="action-buttons">
              <el-button @click="clearCache" size="large">
                <el-icon><Delete /></el-icon>
                æ¸…ç†ç¼“å­˜
              </el-button>
              <el-button @click="resetSettings" type="warning" size="large">
                <el-icon><Refresh /></el-icon>
                é‡ç½®è®¾ç½®
              </el-button>
              <el-button @click="resetAllData" type="danger" size="large">
                <el-icon><Warning /></el-icon>
                é‡ç½®æ‰€æœ‰æ•°æ®
              </el-button>
            </div>
            <div class="action-tip">
              è°¨æ…æ“ä½œï¼Œé‡ç½®æ•°æ®å°†æ— æ³•æ¢å¤
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å…³äºä¿¡æ¯ -->
    <div class="about-section">
      <div class="learning-card">
        <h3>â„¹ï¸ å…³äºåº”ç”¨</h3>
        <div class="about-content">
          <div class="app-info">
            <h4>æ±‰å­—å­¦ä¹ å·¥å…· v1.0.0</h4>
            <p>ä¸“ä¸ºå°å­¦ç”Ÿè®¾è®¡çš„æ™ºèƒ½æ±‰å­—å­¦ä¹ ç³»ç»Ÿ</p>
          </div>
          
          <div class="features-list">
            <h5>ä¸»è¦åŠŸèƒ½</h5>
            <ul>
              <li>ğŸ¯ æ™ºèƒ½é€‰å­—ç®—æ³•ï¼Œä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„</li>
              <li>ğŸ“Š è¯¦ç»†çš„å­¦ä¹ ç»Ÿè®¡å’Œè¿›åº¦è¿½è¸ª</li>
              <li>ğŸ”„ ç§‘å­¦çš„å¤ä¹ æœºåˆ¶ï¼ŒåŸºäºé—å¿˜æ›²çº¿</li>
              <li>ğŸ® æ¸¸æˆåŒ–å­¦ä¹ ä½“éªŒï¼Œæé«˜å­¦ä¹ å…´è¶£</li>
              <li>ğŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒå¤šè®¾å¤‡ä½¿ç”¨</li>
            </ul>
          </div>
          
          <div class="data-info">
            <h5>æ•°æ®æ¥æº</h5>
            <p>æ±‰å­—æ•°æ®ï¼šå°å­¦ç”Ÿå¿…å­¦2500æ±‰å­—åŠæ‹¼éŸ³è¯è¯­</p>
            <p>ç®—æ³•è®¾è®¡ï¼šåŸºäºè‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿ç†è®º</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="actions-section">
      <div class="learning-card">
        <div class="main-actions">
          <el-button @click="$router.push('/')" size="large">
            <el-icon><ArrowLeft /></el-icon>
            è¿”å›é¦–é¡µ
          </el-button>
          <el-button @click="saveSettings" type="primary" size="large">
            <el-icon><Check /></el-icon>
            ä¿å­˜è®¾ç½®
          </el-button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, watch, nextTick } from 'vue'
// import { useRouter } from 'vue-router' // ä¿ç•™å¤‡ç”¨
import { useLearningStore } from '@/stores/learning'
import { ElMessage, ElMessageBox } from 'element-plus'
import type { LearningSettings, ReviewSettings } from '@/types'

// const router = useRouter() // å½“å‰æœªä½¿ç”¨ï¼Œä½†ä¿ç•™å¤‡ç”¨
const learningStore = useLearningStore()

// è¡¨å•æ•°æ® - ä½¿ç”¨reactiveå¯¹è±¡å¹¶æ‰‹åŠ¨åŒæ­¥
const formSettings = reactive<LearningSettings>({
  å­¦ä¹ æ•°é‡: 10,
  å¤ä¹ æ•°é‡: 15,
  æ£€æŸ¥ç±»å‹: 'æ··åˆæ¨¡å¼',
  å­¦ä¹ èŒƒå›´: 'å…¨æ–°æ±‰å­—',
  æ˜¯å¦æ˜¾ç¤ºå£°è°ƒ: true,
  æ˜¯å¦æ˜¾ç¤ºç¬”ç”»: false,
  å€’è®¡æ—¶ç§’æ•°: 30,
  èµ·å§‹åºå·: 1,
  ç»“æŸåºå·: undefined
})

// å¤ä¹ è®¾ç½®è¡¨å•æ•°æ®
const formReviewSettings = reactive<ReviewSettings>({
  å¤ä¹ æ•°é‡: 15,
  æ£€æŸ¥ç±»å‹: 'æ··åˆæ¨¡å¼',
  å¤ä¹ èŒƒå›´: 'éœ€è¦å¤ä¹ ',
  å€’è®¡æ—¶ç§’æ•°: 30,
  æ˜¯å¦æ˜¾ç¤ºå£°è°ƒ: true,
  æ‰“ä¹±é€‰é¡¹é¡ºåº: true
})

// å…¶ä»–è®¾ç½®
const themeColor = ref('blue')
const fontSize = ref(14)
const dailyReminder = ref(false)
const reminderTime = ref(new Date())
const dailyGoal = ref(10)
const fileInput = ref<HTMLInputElement>()
const settingsFileInput = ref<HTMLInputElement>()

// åŒæ­¥æ ‡å¿—ï¼Œé˜²æ­¢å¾ªç¯æ›´æ–°
const isUpdatingFromStore = ref(false)
const isUpdatingReviewFromStore = ref(false)

// ç›‘å¬formSettingså˜åŒ–ï¼ŒåŒæ­¥åˆ°store
watch(formSettings, (newSettings) => {
  if (!isUpdatingFromStore.value) {
    learningStore.updateSettings(newSettings)
  }
}, { deep: true })

// ç›‘å¬storeå˜åŒ–ï¼ŒåŒæ­¥åˆ°formSettings
watch(() => learningStore.settings, (newSettings) => {
  isUpdatingFromStore.value = true
  Object.assign(formSettings, newSettings)
  
  // ä½¿ç”¨nextTickç¡®ä¿UIæ›´æ–°åå†å…è®¸watchè§¦å‘
  nextTick(() => {
    isUpdatingFromStore.value = false
  })
}, { deep: true, immediate: true })

// ç›‘å¬formReviewSettingså˜åŒ–ï¼ŒåŒæ­¥åˆ°store
watch(formReviewSettings, (newSettings) => {
  if (!isUpdatingReviewFromStore.value) {
    learningStore.updateReviewSettings(newSettings)
  }
}, { deep: true })

// ç›‘å¬storeå˜åŒ–ï¼ŒåŒæ­¥åˆ°formReviewSettings
watch(() => learningStore.reviewSettings, (newSettings) => {
  isUpdatingReviewFromStore.value = true
  Object.assign(formReviewSettings, newSettings)
  
  // ä½¿ç”¨nextTickç¡®ä¿UIæ›´æ–°åå†å…è®¸watchè§¦å‘
  nextTick(() => {
    isUpdatingReviewFromStore.value = false
  })
}, { deep: true, immediate: true })

// ç›‘å¬å…¶ä»–è®¾ç½®å˜åŒ–å¹¶è‡ªåŠ¨ä¿å­˜
watch([themeColor, fontSize, dailyReminder, reminderTime, dailyGoal], () => {
  const otherSettings = {
    themeColor: themeColor.value,
    fontSize: fontSize.value,
    dailyReminder: dailyReminder.value,
    reminderTime: reminderTime.value,
    dailyGoal: dailyGoal.value
  }
  localStorage.setItem('appSettings', JSON.stringify(otherSettings))
}, { deep: true })

// æ–¹æ³•
const saveSettings = () => {
  try {
    // å­¦ä¹ è®¾ç½®å·²ç»è‡ªåŠ¨ä¿å­˜ï¼Œè¿™é‡Œåªéœ€è¦ä¿å­˜å…¶ä»–è®¾ç½®
    const otherSettings = {
      themeColor: themeColor.value,
      fontSize: fontSize.value,
      dailyReminder: dailyReminder.value,
      reminderTime: reminderTime.value,
      dailyGoal: dailyGoal.value
    }
    localStorage.setItem('appSettings', JSON.stringify(otherSettings))
    
    ElMessage.success('æ‰€æœ‰è®¾ç½®å·²æ‰‹åŠ¨ä¿å­˜æˆåŠŸï¼ï¼ˆæ³¨ï¼šå­¦ä¹ è®¾ç½®å’Œå¤ä¹ è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜ï¼‰')
  } catch (error) {
    ElMessage.error('è®¾ç½®ä¿å­˜å¤±è´¥')
  }
}



// å¯¼å‡ºè®¾ç½®åˆ°æœ¬åœ°æ–‡ä»¶
const exportSettings = () => {
  try {
    const allSettings = {
      learningSettings: learningStore.settings,
      reviewSettings: learningStore.reviewSettings,
      appSettings: {
        themeColor: themeColor.value,
        fontSize: fontSize.value,
        dailyReminder: dailyReminder.value,
        reminderTime: reminderTime.value,
        dailyGoal: dailyGoal.value
      },
      exportTime: new Date().toISOString(),
      version: '1.0.0'
    }
    
    const blob = new Blob([JSON.stringify(allSettings, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `æ±‰å­—å­¦ä¹ å·¥å…·-è®¾ç½®å¤‡ä»½-${new Date().toISOString().slice(0, 10)}.json`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
    
    ElMessage.success('è®¾ç½®å¯¼å‡ºæˆåŠŸï¼')
  } catch (error) {
    console.error('å¯¼å‡ºè®¾ç½®å¤±è´¥:', error)
    ElMessage.error('è®¾ç½®å¯¼å‡ºå¤±è´¥')
  }
}

// è§¦å‘è®¾ç½®æ–‡ä»¶è¾“å…¥
const triggerSettingsFileInput = () => {
  settingsFileInput.value?.click()
}

// å¤„ç†è®¾ç½®æ–‡ä»¶å˜åŒ–
const handleSettingsFileChange = (event: Event) => {
  const input = event.target as HTMLInputElement
  const file = input.files?.[0]
  if (!file) return
  
  const reader = new FileReader()
  reader.onload = (e) => {
    try {
      const content = e.target?.result as string
      const data = JSON.parse(content)
      
      // éªŒè¯æ•°æ®æ ¼å¼
      if (!data.learningSettings && !data.reviewSettings && !data.appSettings) {
        throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„è®¾ç½®æ–‡ä»¶')
      }
      
      // å¯¼å…¥å­¦ä¹ è®¾ç½®
      if (data.learningSettings) {
        learningStore.updateSettings(data.learningSettings)
        // formSettingsä¼šé€šè¿‡watchè‡ªåŠ¨åŒæ­¥
      }
      
      // å¯¼å…¥å¤ä¹ è®¾ç½®
      if (data.reviewSettings) {
        learningStore.updateReviewSettings(data.reviewSettings)
        // formReviewSettingsä¼šé€šè¿‡watchè‡ªåŠ¨åŒæ­¥
      }
      
      // å¯¼å…¥åº”ç”¨è®¾ç½®
      if (data.appSettings) {
        const settings = data.appSettings
        themeColor.value = settings.themeColor || 'blue'
        fontSize.value = settings.fontSize || 14
        dailyReminder.value = settings.dailyReminder || false
        reminderTime.value = settings.reminderTime ? new Date(settings.reminderTime) : new Date()
        dailyGoal.value = settings.dailyGoal || 10
        
        localStorage.setItem('appSettings', JSON.stringify(settings))
      }
      
      ElMessage.success('è®¾ç½®å¯¼å…¥æˆåŠŸï¼')
    } catch (error) {
      console.error('å¯¼å…¥è®¾ç½®å¤±è´¥:', error)
      ElMessage.error('è®¾ç½®å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®')
    }
  }
  reader.readAsText(file)
  
  // æ¸…ç©ºinputå€¼ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
  input.value = ''
}

const exportData = () => {
  try {
    // ç¡®ä¿æ•°æ®å®Œæ•´æ€§
    const recordsData: { [key: string]: any } = {}
    learningStore.learningRecords.forEach((record, key) => {
      recordsData[key] = record
    })
    
    const data = {
      userStats: learningStore.userStats,
      learningRecords: recordsData,
      settings: learningStore.settings,
      exportTime: new Date().toISOString(),
      version: '1.0.0',
      totalRecords: learningStore.learningRecords.size
    }
    

    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `hanzi-learning-backup-${new Date().toISOString().split('T')[0]}.json`
    a.click()
    URL.revokeObjectURL(url)
    
    ElMessage.success(`æ•°æ®å¯¼å‡ºæˆåŠŸï¼åŒ…å« ${data.totalRecords} æ¡å­¦ä¹ è®°å½•`)
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error)
    ElMessage.error('æ•°æ®å¯¼å‡ºå¤±è´¥ï¼š' + (error as Error).message)
  }
}

const triggerFileInput = () => {
  fileInput.value?.click()
}

const handleFileChange = (event: Event) => {
  const target = event.target as HTMLInputElement
  if (target.files && target.files.length > 0) {
    const file = target.files[0]
    handleImport(file)
  }
}

const handleImport = (file: File) => {
  const reader = new FileReader()
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target?.result as string)
      
      // è¯¦ç»†éªŒè¯æ•°æ®æ ¼å¼
      if (!data.userStats) {
        throw new Error('ç¼ºå°‘ç”¨æˆ·ç»Ÿè®¡æ•°æ® (userStats)')
      }
      
      if (!data.learningRecords) {
        throw new Error('ç¼ºå°‘å­¦ä¹ è®°å½•æ•°æ® (learningRecords)')
      }
      
      // éªŒè¯userStatsç»“æ„
      const requiredStatsFields = ['æ€»å­¦ä¹ æ±‰å­—æ•°', 'æ€»æŒæ¡æ±‰å­—æ•°', 'æ•´ä½“æ­£ç¡®ç‡', 'å­¦ä¹ å¤©æ•°', 'è¿ç»­å­¦ä¹ å¤©æ•°', 'æœ€åå­¦ä¹ æ—¥æœŸ']
      for (const field of requiredStatsFields) {
        if (!(field in data.userStats)) {
          throw new Error(`ç”¨æˆ·ç»Ÿè®¡æ•°æ®ç¼ºå°‘å­—æ®µ: ${field}`)
        }
      }
      
      // å¤„ç†learningRecordsæ•°æ®æ ¼å¼
      let recordsData = data.learningRecords
      let recordCount = 0
      
      // å¦‚æœæ˜¯å¯¹è±¡æ ¼å¼ï¼Œè½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
      if (typeof recordsData === 'object' && !Array.isArray(recordsData)) {
        recordsData = Object.entries(recordsData)
        recordCount = Object.keys(data.learningRecords).length
      } else if (Array.isArray(recordsData)) {
        recordCount = recordsData.length
      }
      

      
      // å¯¼å…¥æ•°æ®åˆ°localStorage
      localStorage.setItem('userStats', JSON.stringify(data.userStats))
      localStorage.setItem('learningRecords', JSON.stringify(recordsData))
      
      if (data.settings) {
        localStorage.setItem('learningSettings', JSON.stringify(data.settings))
      }
      
      // é‡æ–°åŠ è½½storeæ•°æ®
      learningStore.loadFromStorage()
      
      ElMessage.success(`æ•°æ®å¯¼å…¥æˆåŠŸï¼æ¢å¤äº† ${recordCount} æ¡å­¦ä¹ è®°å½•`)
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      if (fileInput.value) {
        fileInput.value.value = ''
      }
    } catch (error) {
      console.error('å¯¼å…¥é”™è¯¯:', error)
      const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
      ElMessage.error(`æ•°æ®å¯¼å…¥å¤±è´¥: ${errorMsg}`)
    }
  }
  
  reader.onerror = () => {
    ElMessage.error('æ–‡ä»¶è¯»å–å¤±è´¥')
  }
  
  reader.readAsText(file)
}

const generateTestData = () => {
  learningStore.generateTestData()
  ElMessage.success('æµ‹è¯•æ•°æ®å·²ç”Ÿæˆï¼å¯ä»¥åœ¨ç»Ÿè®¡é¡µé¢æŸ¥çœ‹æ•ˆæœï¼Œä¹Ÿå¯ä»¥æµ‹è¯•å¯¼å…¥å¯¼å‡ºåŠŸèƒ½')
}

const testImportExport = async () => {
  try {
    // å…ˆç”Ÿæˆæµ‹è¯•æ•°æ®
    learningStore.generateTestData()
    
    // å¯¼å‡ºæ•°æ®
    const recordsData: { [key: string]: any } = {}
    learningStore.learningRecords.forEach((record, key) => {
      recordsData[key] = record
    })
    
    const exportData = {
      userStats: learningStore.userStats,
      learningRecords: recordsData,
      settings: learningStore.settings,
      exportTime: new Date().toISOString(),
      version: '1.0.0'
    }
    
    // æ¨¡æ‹Ÿå¯¼å…¥è¿‡ç¨‹
    const jsonString = JSON.stringify(exportData, null, 2)
    const mockFile = new File([jsonString], 'test-data.json', { type: 'application/json' })
    
    // å¤‡ä»½å½“å‰æ•°æ®
    const backup = {
      userStats: { ...learningStore.userStats },
      learningRecords: new Map(learningStore.learningRecords),
      settings: { ...learningStore.settings }
    }
    
    // æ¸…ç©ºå½“å‰æ•°æ®
    learningStore.learningRecords.clear()
    
    // æµ‹è¯•å¯¼å…¥
    const reader = new FileReader()
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target?.result as string)
        
        let recordsData = data.learningRecords
        if (typeof recordsData === 'object' && !Array.isArray(recordsData)) {
          recordsData = Object.entries(recordsData)
        }
        
        localStorage.setItem('userStats', JSON.stringify(data.userStats))
        localStorage.setItem('learningRecords', JSON.stringify(recordsData))
        localStorage.setItem('learningSettings', JSON.stringify(data.settings))
        
        learningStore.loadFromStorage()
        
        ElMessage.success(`å¯¼å…¥å¯¼å‡ºæµ‹è¯•æˆåŠŸï¼æ¢å¤äº† ${learningStore.learningRecords.size} æ¡è®°å½•`)
      } catch (error) {
        // æ¢å¤å¤‡ä»½æ•°æ®
        learningStore.learningRecords = backup.learningRecords
        Object.assign(learningStore.userStats, backup.userStats)
        Object.assign(learningStore.settings, backup.settings)
        
        ElMessage.error('å¯¼å…¥å¯¼å‡ºæµ‹è¯•å¤±è´¥ï¼Œå·²æ¢å¤åŸæ•°æ®')
        console.error('æµ‹è¯•é”™è¯¯:', error)
      }
    }
    reader.readAsText(mockFile)
    
  } catch (error) {
    ElMessage.error('å¯¼å…¥å¯¼å‡ºæµ‹è¯•å¤±è´¥')
    console.error('æµ‹è¯•é”™è¯¯:', error)
  }
}

const clearCache = () => {
  try {
    // æ¸…ç†éå…³é”®ç¼“å­˜æ•°æ®
    const keysToKeep = ['learningRecords', 'userStats', 'learningSettings']
    Object.keys(localStorage).forEach(key => {
      if (!keysToKeep.includes(key)) {
        localStorage.removeItem(key)
      }
    })
    ElMessage.success('ç¼“å­˜æ¸…ç†å®Œæˆ')
  } catch (error) {
    ElMessage.error('ç¼“å­˜æ¸…ç†å¤±è´¥')
  }
}

const resetSettings = async () => {
  try {
    await ElMessageBox.confirm(
      'ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      'é‡ç½®è®¾ç½®',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )
    
    // é‡ç½®è®¾ç½®
    localStorage.removeItem('learningSettings')
    localStorage.removeItem('appSettings')
    
    ElMessage.success('è®¾ç½®é‡ç½®æˆåŠŸï¼Œé¡µé¢å³å°†åˆ·æ–°')
    setTimeout(() => {
      window.location.reload()
    }, 1000)
  } catch {
    // ç”¨æˆ·å–æ¶ˆ
  }
}

const resetAllData = async () => {
  try {
    await ElMessageBox.confirm(
      'ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼ŸåŒ…æ‹¬å­¦ä¹ è®°å½•ã€ç»Ÿè®¡æ•°æ®å’Œè®¾ç½®ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
      'é‡ç½®æ‰€æœ‰æ•°æ®',
      {
        confirmButtonText: 'ç¡®å®šé‡ç½®',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )
    
    // æ¸…ç©ºæ‰€æœ‰æ•°æ®
    localStorage.clear()
    
    ElMessage.success('æ•°æ®é‡ç½®å®Œæˆï¼Œé¡µé¢å³å°†åˆ·æ–°')
    setTimeout(() => {
      window.location.reload()
    }, 1000)
  } catch {
    // ç”¨æˆ·å–æ¶ˆ
  }
}

// åˆå§‹åŒ–
onMounted(() => {
  // ç¡®ä¿formSettingsä¸storeåŒæ­¥ï¼ˆwatchçš„immediateå¯èƒ½ä¸å¤ŸåŠæ—¶ï¼‰
  isUpdatingFromStore.value = true
  Object.assign(formSettings, learningStore.settings)
  nextTick(() => {
    isUpdatingFromStore.value = false
  })
  
  // ç¡®ä¿formReviewSettingsä¸storeåŒæ­¥
  isUpdatingReviewFromStore.value = true
  Object.assign(formReviewSettings, learningStore.reviewSettings)
  nextTick(() => {
    isUpdatingReviewFromStore.value = false
  })
  
  // åŠ è½½å…¶ä»–è®¾ç½®
  try {
    const savedSettings = localStorage.getItem('appSettings')
    if (savedSettings) {
      const settings = JSON.parse(savedSettings)
      themeColor.value = settings.themeColor || 'blue'
      fontSize.value = settings.fontSize || 14
      dailyReminder.value = settings.dailyReminder || false
      reminderTime.value = settings.reminderTime ? new Date(settings.reminderTime) : new Date()
      dailyGoal.value = settings.dailyGoal || 10
    }
  } catch (error) {
    console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error)
  }
})
</script>

<style lang="scss" scoped>
.settings-container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
  
  > div {
    margin-bottom: 30px;
  }
}

.settings-header {
  .header-card {
    text-align: center;
    padding: 40px;
    
    h2 {
      color: #409EFF;
      margin-bottom: 16px;
    }
    
    .description {
      color: #666;
      font-size: 16px;
    }
  }
}

.learning-card {
  padding: 30px;
  
  h3 {
    font-size: 20px;
    color: #333;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .setting-tip {
    font-size: 12px;
    color: #999;
    margin-top: 8px;
    line-height: 1.4;
  }
}

.data-actions {
  .action-group {
    margin-bottom: 30px;
    
    h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 16px;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    
    .action-tip {
      font-size: 12px;
      color: #999;
      line-height: 1.4;
    }
  }
}

.about-content {
  .app-info {
    margin-bottom: 24px;
    
    h4 {
      font-size: 18px;
      color: #409EFF;
      margin-bottom: 8px;
    }
    
    p {
      color: #666;
      font-size: 14px;
    }
  }
  
  .features-list, .data-info {
    margin-bottom: 20px;
    
    h5 {
      font-size: 14px;
      color: #333;
      margin-bottom: 12px;
      font-weight: 600;
    }
    
    ul {
      list-style: none;
      padding: 0;
      
      li {
        font-size: 14px;
        color: #666;
        margin-bottom: 6px;
        line-height: 1.4;
      }
    }
    
    p {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
      line-height: 1.4;
    }
  }
}

.main-actions {
  display: flex;
  justify-content: center;
  gap: 20px;
}

// å“åº”å¼è®¾è®¡
@media (max-width: 768px) {
  .settings-container {
    padding: 10px;
  }
  
  .learning-card {
    padding: 20px;
  }
  
  .action-buttons {
    flex-direction: column;
    
    .el-button {
      width: 100%;
    }
  }
  
  .main-actions {
    flex-direction: column;
    
    .el-button {
      width: 100%;
    }
  }
  
  .el-form-item {
    flex-direction: column;
    
    .el-form-item__label {
      text-align: left;
      width: auto !important;
      margin-bottom: 8px;
    }
    
    .el-form-item__content {
      margin-left: 0 !important;
    }
  }
}
</style> 